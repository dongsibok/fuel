<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜ìˆ˜ì¦ ëª©ë¡ (Google Sheets ì—°ë™)</title>
  <style>
    @page {
      size: A4;
      margin-top: 20mm;
      margin-left: 10mm;
      margin-right: 10mm;
      margin-bottom: 10mm;
    }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      color: #333; line-height: 1.2; font-size: 0.9em; background: #f5f5f5;
    }
    .page {
      width: 190mm; margin: 20px auto; display: flex; flex-direction: column;
      min-height: calc(297mm - 40mm);
      border: 1px solid #333; border-radius: 6px; padding: 8px; 
      box-sizing: border-box; background: #fff;
    }
    h1 { 
      text-align: center; margin: 10px 0 14px; font-size: 2em; 
      letter-spacing: 0.1em; font-weight: 700; 
    }
    table { 
      width: 100%; border-collapse: collapse; table-layout: fixed; 
      margin: 0; page-break-inside: avoid; 
    }
    th, td { 
      border: 1px solid #333; padding: 6px 8px; text-align: center; 
      vertical-align: middle; min-height: 28px; word-break: break-word; 
    }
    th { background-color: #f2f2f2; font-weight: 700; }
    .header-table { margin-bottom: 6px; }
    .header-table td { 
      font-weight: bold; text-align: center; width: 25%; 
      background-color: #f2f2f2; 
    }
    .header-table .input-cell { 
      width: 75%; font-weight: normal; background-color: white; 
      text-align: center; 
    }
    .data-table.summary { margin: 0; border-bottom: none; }
    .data-table.summary th, .data-table.summary td { width: 50%; }
    .data-table.detail-table { margin: 0; border-top: none; }
    .data-table.detail-table th, .data-table.detail-table td { width: 20%; }
    input[type="text"], select, input[type="date"] {
      width: 100%; box-sizing: border-box; border: 1px solid #ddd; 
      outline: none; background-color: white; padding: 4px; margin: 0; 
      font-size: 1em; text-align: center; border-radius: 3px;
    }
    input[type="text"]:focus, select:focus, input[type="date"]:focus {
      border-color: #4a6da7;
      box-shadow: 0 0 0 2px rgba(74, 109, 167, 0.1);
    }
    select { 
      appearance: none; -webkit-appearance: none; -moz-appearance: none; 
      text-align-last: center; cursor: pointer;
    }
    .print-button, .save-button, .clear-button {
      display: inline-block; min-width: 120px; margin: 8px 6px; 
      padding: 10px 16px; text-align: center; color: #fff; 
      border: none; border-radius: 6px; cursor: pointer; 
      font-size: 14px; font-weight: 600;
      transition: all 0.2s;
    }
    .print-button { background-color: #4a6da7; }
    .print-button:hover { background-color: #3a5d97; }
    .save-button { background-color: #2f855a; }
    .save-button:hover { background-color: #276749; }
    .save-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .clear-button { background-color: #dc2626; }
    .clear-button:hover { background-color: #b91c1c; }
    .btn-row { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
    .receipt-box { 
      flex: 1 1 auto; border: 1px solid #333; border-radius: 4px; 
      min-height: 90mm; box-sizing: border-box; margin-top: 0; 
      background: #fff; page-break-inside: avoid; position: relative; 
      padding: 4px; 
    }
    .transaction-date { 
      position: absolute; top: 8px; left: 8px; font-size: 0.9em; 
      font-weight: 600; display: flex; align-items: center; gap: 6px; 
    }
    .transaction-date label { white-space: nowrap; }
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.85); color: #fff; padding: 12px 20px; 
      border-radius: 6px; font-size: 14px; display: none; z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .required { color: #dc2626; margin-left: 2px; }
    @media print {
      body { background: #fff; }
      .print-button, .save-button, .clear-button { display: none; }
      .page { 
        box-shadow: none; border: none; padding: 0; margin: 0; 
        background: #fff; 
      }
      input[type="text"], select, input[type="date"] { 
        border: none !important; background-color: transparent !important; 
        box-shadow: none !important;
      }
    }
  </style>
</head>
<body>

  <div class="page">
    <h1>ì˜ ìˆ˜ ì¦ ëª© ë¡</h1>

    <div class="btn-row">
      <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
      <button class="save-button" id="saveBtn">ğŸ’¾ Google ì‹œíŠ¸ì— ì €ì¥</button>
      <button class="clear-button" onclick="clearForm()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    </div>

    <table class="header-table">
      <tbody>
        <tr>
          <td>ê¸°ì•ˆëª…(ìƒì„¸ë‚´ì—­)</td>
          <td class="input-cell" colspan="4">ì°¨ëŸ‰ìœ ë¥˜ë¹„</td>
        </tr>
      </tbody>
    </table>

    <table class="data-table summary">
      <thead>
        <tr>
          <th>ê±´ìˆ˜<span class="required">*</span></th>
          <th>ê¸ˆì•¡<span class="required">*</span></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" id="countInput" onblur="formatCount(this)" placeholder="ì˜ˆ) 12"></td>
          <td><input type="text" id="amountInput" onblur="formatAmount(this)" placeholder="ì˜ˆ) 350000"></td>
        </tr>
      </tbody>
    </table>

    <table class="data-table detail-table">
      <thead>
        <tr>
          <th>ì°¨ì¢…<span class="required">*</span></th>
          <th>ì£¼ìœ ì†Œ</th>
          <th>ì£¼ìœ ì</th>
          <th>í˜„ì¬km</th>
          <th>ì¢…ì „km</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select id="carType" onchange="handleCarTypeChange()">
              <option value="">ì„ íƒ</option>
              <option value="ì‹ ìŠ¤íŒŒí¬">ì‹ ìŠ¤íŒŒí¬</option>
              <option value="êµ¬ìŠ¤íŒŒí¬">êµ¬ìŠ¤íŒŒí¬</option>
              <option value="ë ˆì´">ë ˆì´</option>
              <option value="ë§ˆì‚¬íšŒìŠ¤íƒ€ë ‰ìŠ¤">ë§ˆì‚¬íšŒìŠ¤íƒ€ë ‰ìŠ¤</option>
              <option value="ë¦¬í”„íŠ¸ìŠ¤íƒ€ë ‰ìŠ¤">ë¦¬í”„íŠ¸ìŠ¤íƒ€ë ‰ìŠ¤</option>
              <option value="ì´ì¹´ìš´í‹°">ì´ì¹´ìš´í‹°</option>
            </select>
          </td>
          <td>
            <select id="gasStationSelect" onchange="handleGasStationChange()">
              <option value="">ì„ íƒ</option>
              <option value="ì—´ë¦°ì£¼ìœ ì†Œ">ì—´ë¦°ì£¼ìœ ì†Œ</option>
              <option value="GSì¹¼í…ìŠ¤">GSì¹¼í…ìŠ¤</option>
              <option value="SKì—ë„ˆì§€">SKì—ë„ˆì§€</option>
              <option value="í˜„ëŒ€ì˜¤ì¼ë±…í¬">í˜„ëŒ€ì˜¤ì¼ë±…í¬</option>
              <option value="S-OIL">S-OIL</option>
              <option value="ì§ì ‘ì…ë ¥">ğŸ“ ì§ì ‘ì…ë ¥</option>
            </select>
            <input type="text" id="gasStationInput" placeholder="ì£¼ìœ ì†Œëª… ì…ë ¥" style="display:none;">
          </td>
          <td><input type="text" id="driver" placeholder="ì˜ˆ) í™ê¸¸ë™"></td>
          <td><input type="text" id="currentKm" placeholder="ì˜ˆ) 28450"></td>
          <td><input type="text" id="previousKm" placeholder="ì˜ˆ) 27510"></td>
        </tr>
      </tbody>
    </table>

    <div class="receipt-box">
      <div class="transaction-date">
        <label for="transactionDate">ê±°ë˜ì¼ì‹œ<span class="required">*</span>:</label>
        <input type="date" id="transactionDate">
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ====== ì°¨ì¢…ë³„ ì£¼í–‰ê±°ë¦¬ ì €ì¥ ======
    function saveKmData(carType, currentKm) {
      if (!carType || !currentKm) return;
      const data = getKmData();
      data[carType] = currentKm;
      localStorage.setItem('carKmData', JSON.stringify(data));
    }

    function getKmData() {
      const stored = localStorage.getItem('carKmData');
      return stored ? JSON.parse(stored) : {};
    }

    function loadPreviousKm(carType) {
      if (!carType) return;
      const data = getKmData();
      const previousKm = data[carType];
      
      if (previousKm) {
        document.getElementById('previousKm').value = previousKm;
        showToast(`${carType}ì˜ ì´ì „ ì£¼í–‰ê±°ë¦¬ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤`, true);
      }
    }

    // ====== ì°¨ì¢… ë³€ê²½ í•¸ë“¤ëŸ¬ ======
    function handleCarTypeChange() {
      const carType = document.getElementById('carType').value;
      loadPreviousKm(carType);
    }

    // ====== ì£¼ìœ ì†Œ ì„ íƒ í•¸ë“¤ëŸ¬ ======
    function handleGasStationChange() {
      const select = document.getElementById('gasStationSelect');
      const input = document.getElementById('gasStationInput');
      
      if (select.value === 'ì§ì ‘ì…ë ¥') {
        select.style.display = 'none';
        input.style.display = 'block';
        input.focus();
        input.value = '';
      }
    }

    // ì§ì ‘ì…ë ¥ í•„ë“œì—ì„œ í¬ì»¤ìŠ¤ ìƒìœ¼ë©´ ë‹¤ì‹œ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
    window.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('gasStationInput');
      const select = document.getElementById('gasStationSelect');
      
      input.addEventListener('blur', () => {
        if (!input.value.trim()) {
          setTimeout(() => {
            input.style.display = 'none';
            select.style.display = 'block';
            select.value = '';
          }, 150);
        }
      });
      
      // ì—”í„°í‚¤ ì…ë ¥ ì‹œ í¬ì»¤ìŠ¤ ì´ë™
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          input.blur();
        }
      });
    });

    // ====== í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì…ë ¥ ======
    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('transactionDate').value = today;
    });

    // ====== UI Formatting ======
    function formatCount(input) {
      let value = (input.value || '').replace(/[^0-9]/g, '');
      input.value = value ? Number(value) + "ê±´" : "";
    }
    
    function formatAmount(input) {
      let raw = (input.value || '').replace(/[^0-9]/g, '');
      input.value = raw ? "ê¸ˆ" + Number(raw).toLocaleString('ko-KR') + "ì›" : "";
    }

    // ====== Google Apps Script Web App URL ======
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwL79CpGJx4VsTIqEbxim53RS0b6AVvPfu2Qa5x1RwIl2rbyHWlHwPnjrjWhvKQ3s1zjg/exec";

    // ====== Helpers ======
    function stripNumberDecorations(str) {
      if (!str) return "";
      const digits = String(str).replace(/[^\d]/g, "");
      return digits;
    }

    function showToast(message, ok=true) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = ok ? 'rgba(15,111,54,0.92)' : 'rgba(180,38,38,0.92)';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    function clearForm() {
      if (!confirm('ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      document.getElementById('countInput').value = '';
      document.getElementById('amountInput').value = '';
      document.getElementById('carType').value = '';
      
      // ì£¼ìœ ì†Œ í•„ë“œ ì´ˆê¸°í™”
      const gasSelect = document.getElementById('gasStationSelect');
      const gasInput = document.getElementById('gasStationInput');
      gasSelect.value = '';
      gasSelect.style.display = 'block';
      gasInput.style.display = 'none';
      gasInput.value = '';
      
      document.getElementById('driver').value = '';
      document.getElementById('currentKm').value = '';
      document.getElementById('previousKm').value = '';
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('transactionDate').value = today;
      
      showToast('í¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', true);
    }

    // ====== Validation ======
    function validateForm() {
      const required = {
        'ê±°ë˜ì¼ì‹œ': document.getElementById('transactionDate').value,
        'ì°¨ì¢…': document.getElementById('carType').value,
        'ê±´ìˆ˜': stripNumberDecorations(document.getElementById('countInput').value),
        'ê¸ˆì•¡': stripNumberDecorations(document.getElementById('amountInput').value)
      };

      for (const [field, value] of Object.entries(required)) {
        if (!value) {
          showToast(`${field}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”`, false);
          return false;
        }
      }
      return true;
    }

    // ====== Save Handler ======
    async function saveToGoogleSheets() {
      if (!validateForm()) return;

      // ì£¼ìœ ì†Œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì„ íƒ ë˜ëŠ” ì§ì ‘ì…ë ¥)
      const gasSelect = document.getElementById('gasStationSelect');
      const gasInput = document.getElementById('gasStationInput');
      const gasStation = gasInput.style.display === 'none' 
        ? gasSelect.value 
        : gasInput.value;

      const payload = {
        ë‚ ì§œ: document.getElementById('transactionDate').value || "",
        ì°¨ì¢…: document.getElementById('carType').value || "",
        ì£¼ìœ ì†Œ: gasStation || "",
        ì£¼ìœ ì: document.getElementById('driver').value || "",
        í˜„ì¬km: stripNumberDecorations(document.getElementById('currentKm').value),
        ì¢…ì „km: stripNumberDecorations(document.getElementById('previousKm').value),
        ê±´ìˆ˜: stripNumberDecorations(document.getElementById('countInput').value),
        ê¸ˆì•¡: stripNumberDecorations(document.getElementById('amountInput').value)
      };

      const btn = document.getElementById('saveBtn');
      btn.disabled = true; 
      btn.textContent = 'ğŸ’¾ ì €ì¥ ì¤‘...';

      try {
        if (!WEB_APP_URL || WEB_APP_URL.includes('YOUR_WEB_APP_URL_HERE')) {
          throw new Error('ë¨¼ì € WEB_APP_URLì„ ë³¸ì¸ì˜ Apps Script ë°°í¬ ì£¼ì†Œë¡œ ë°”ê¿”ì£¼ì„¸ìš”.');
        }
        
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
        showToast('Google ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…', true);
        
        // ì €ì¥ í›„ í¼ ì´ˆê¸°í™” ì˜µì…˜
        setTimeout(() => {
          if (confirm('ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í¼ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            // í˜„ì¬kmë¥¼ ì €ì¥ í›„ ì´ˆê¸°í™”
            const carType = document.getElementById('carType').value;
            const currentKm = stripNumberDecorations(document.getElementById('currentKm').value);
            
            if (carType && currentKm) {
              saveKmData(carType, currentKm);
            }
            
            clearForm();
          } else {
            // ì´ˆê¸°í™”í•˜ì§€ ì•Šì•„ë„ km ë°ì´í„°ëŠ” ì €ì¥
            const carType = document.getElementById('carType').value;
            const currentKm = stripNumberDecorations(document.getElementById('currentKm').value);
            
            if (carType && currentKm) {
              saveKmData(carType, currentKm);
            }
          }
        }, 500);
        
      } catch (e) {
        console.error(e);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, false);
      } finally {
        btn.disabled = false; 
        btn.textContent = 'ğŸ’¾ Google ì‹œíŠ¸ì— ì €ì¥';
      }
    }

    document.getElementById('saveBtn').addEventListener('click', saveToGoogleSheets);
  </script>
</body>
</html>
